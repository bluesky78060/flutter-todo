name: Flutter Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run Tests and Generate Coverage
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.7'
        channel: 'stable'
        cache: true

    - name: Verify Flutter installation
      run: flutter --version

    - name: Install dependencies
      run: flutter pub get

    - name: Run code generation
      run: dart run build_runner build --delete-conflicting-outputs

    - name: Analyze code
      run: flutter analyze

    - name: Run tests with coverage
      run: flutter test --coverage test/unit/ test/widget/

    - name: Generate coverage report
      run: |
        sudo apt-get update
        sudo apt-get install -y lcov
        genhtml coverage/lcov.info -o coverage/html

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage/lcov.info
        fail_ci_if_error: false
        verbose: true

    - name: Upload coverage HTML report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage/html/
        retention-days: 30

    - name: Check test results
      run: |
        if [ $? -eq 0 ]; then
          echo "âœ… All tests passed!"
        else
          echo "âŒ Tests failed!"
          exit 1
        fi

    - name: Comment coverage on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const lcov = fs.readFileSync('coverage/lcov.info', 'utf8');
          const lines = lcov.split('\n');

          let totalLines = 0;
          let hitLines = 0;

          lines.forEach(line => {
            if (line.startsWith('LF:')) {
              totalLines += parseInt(line.split(':')[1]);
            }
            if (line.startsWith('LH:')) {
              hitLines += parseInt(line.split(':')[1]);
            }
          });

          const coverage = totalLines > 0 ? ((hitLines / totalLines) * 100).toFixed(2) : 0;

          const comment = `## ðŸ“Š Test Coverage Report

          **Coverage**: ${coverage}%
          **Lines Tested**: ${hitLines} / ${totalLines}

          âœ… All tests passed!

          [View detailed coverage report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
