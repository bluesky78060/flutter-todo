# 실제 기기 알림 테스트 가이드

## 📱 실제 기기에서 알림이 안 되는 주요 원인

### 1. 권한 문제 (가장 흔한 원인)

#### Android 13+ (API 33+) 알림 권한
실제 기기에서는 **반드시** 알림 권한을 수동으로 허용해야 합니다.

**확인 방법**:
```
설정 > 앱 > DoDo > 알림
```
- "알림 허용" 토글이 **켜짐(ON)** 상태인지 확인
- 만약 꺼져 있으면 켜기

**주의**: 앱 설치 후 첫 실행 시 권한 팝업이 뜨는데, "허용 안 함"을 누르면 다시 팝업이 뜨지 않습니다. 이 경우 설정에서 수동으로 켜야 합니다.

#### Android 12+ (API 31+) 정확한 알람 권한
예약 알림이 정확한 시간에 발생하려면 이 권한이 필요합니다.

**확인 방법**:
```
설정 > 특수 접근 > 정확한 알람 > DoDo
```
- 토글이 **허용** 상태인지 확인
- 또는 `설정 > 앱 > DoDo > 정확한 알람 및 리마인더`에서 허용

### 2. 배터리 최적화 (삼성, Xiaomi, OPPO, Vivo 등)

많은 제조사에서 배터리 절약을 위해 백그라운드 앱을 강제 종료합니다.

#### 삼성 기기
```
설정 > 배터리 및 디바이스 케어 > 배터리 > 백그라운드 사용 제한
```
- DoDo 앱이 "제한 없음" 또는 "절전 제외"인지 확인
- "절전" 또는 "깊은 절전"에 있으면 알림이 안 됨

#### Xiaomi 기기
```
설정 > 앱 > 앱 관리 > DoDo
```
- "자동 실행" 허용
- "배터리 절약" → "제한 없음"
- "백그라운드 실행" 허용

#### OPPO/Realme 기기
```
설정 > 배터리 > 앱 절전 > DoDo
```
- "제한 안 함" 선택

#### Vivo 기기
```
설정 > 배터리 > 백그라운드 앱 관리 > DoDo
```
- "백그라운드 실행 허용" 켜기

### 3. 알림 채널 중요도

알림 채널은 **한 번 생성되면 코드로 중요도를 변경할 수 없습니다**.

**문제 상황**:
- 이전 버전에서 낮은 중요도로 채널이 생성되었다면, 새 버전에서 코드를 수정해도 반영 안 됨

**해결 방법**:
1. 앱 완전히 삭제 (설정 > 앱 > DoDo > 제거)
2. 캐시 및 데이터도 모두 삭제
3. 앱 재설치

**현재 채널 설정**:
- 채널 ID: `todo_notifications_v2`
- 중요도: `Importance.max` (최고)
- 우선순위: `Priority.max` (최고)

### 4. 시간대(Timezone) 문제

기기의 시간대가 다르면 알림이 과거로 계산되어 발생하지 않을 수 있습니다.

**현재 코드 동작**:
```dart
// 시스템 타임존 식별 실패 시 Asia/Seoul로 폴백
final location = await tz.getLocation(timeZoneName);
```

**테스트 방법**:
- "지금으로부터 2분 후" 알림을 설정해서 확실히 미래 시간인지 확인
- 절대 시간(예: 오후 3:00)보다는 상대 시간(2분 후)으로 테스트

### 5. 방해 금지 모드

**확인 방법**:
```
설정 > 알림 > 방해 금지
```
- 방해 금지 모드가 켜져 있으면 알림이 표시되지 않음
- 예외 설정에 DoDo를 추가하거나 방해 금지 모드를 끔

## 🔍 진단 절차

### Step 1: 완전히 새로 시작
```bash
# 1. 앱 완전히 삭제
adb uninstall kr.bluesky.dodo

# 2. 최신 APK 설치
adb install build/app/outputs/flutter-apk/app-release-v1.0.2+11.apk

# 3. 앱 실행
adb shell am start -n kr.bluesky.dodo/.MainActivity
```

### Step 2: 권한 확인
앱 실행 시 나타나는 **모든 권한 팝업을 "허용"** 으로 선택:
1. 알림 권한 허용
2. 정확한 알람 권한 허용
3. 배터리 최적화 제외 허용

### Step 3: 설정에서 수동 확인
1. **알림 권한**: 설정 > 앱 > DoDo > 알림 → 켜짐
2. **정확한 알람**: 설정 > 특수 접근 > 정확한 알람 > DoDo → 허용
3. **배터리 최적화**: 설정 > 배터리 > 백그라운드 제한 → DoDo 제한 없음

### Step 4: 간단한 테스트
1. 앱에서 새 할일 추가
2. 알림 시간을 **지금으로부터 2분 후**로 설정
3. 앱을 백그라운드로 보냄 (홈 버튼)
4. 2분 기다림
5. 알림이 표시되는지 확인

### Step 5: 앱 종료 상태 테스트 (v1.0.2+11 핵심 수정사항)
1. 앱에서 새 할일 추가
2. 알림 시간을 **지금으로부터 2분 후**로 설정
3. 앱을 **완전히 종료** (최근 앱 목록에서 스와이프로 제거)
4. 2분 기다림
5. 알림이 표시되고, 탭하면 앱이 열리는지 확인

## 📋 로그 확인 방법

실제 기기를 연결한 상태에서:

```bash
# 실시간 로그 확인
adb logcat | grep -E "(flutter|DoDo|notification|alarm)"

# 또는 전체 로그 저장
adb logcat > device_log.txt

# 알림 관련 에러만 확인
adb logcat | grep -i "notification"
```

**주요 확인 사항**:
- `Permission denied` → 권한 문제
- `SecurityException` → 정확한 알람 권한 문제
- `Notification not posted` → 채널 또는 중요도 문제
- `NullPointerException` → 리소스 누락 문제

## ✅ 체크리스트

테스트 전에 다음을 모두 확인하세요:

- [ ] 앱을 완전히 삭제하고 v1.0.2+11로 재설치했다
- [ ] 알림 권한이 허용 상태다
- [ ] 정확한 알람 권한이 허용 상태다
- [ ] 배터리 최적화에서 제외되었다 (또는 제한 없음)
- [ ] 방해 금지 모드가 꺼져 있다
- [ ] 알림 시간을 "미래 시간"(지금으로부터 2분 후)으로 설정했다
- [ ] 기기의 시스템 시간이 정확하다
- [ ] 알림음/진동 설정이 켜져 있다

## 🔧 v1.0.2+11 변경사항

이 버전에서 해결된 문제:
- ✅ 앱 종료 시 알림 크래시 문제 완전 해결
- ✅ 백그라운드 알림 핸들러 추가 (`onDidReceiveBackgroundNotificationResponse`)
- ✅ `@pragma('vm:entry-point')` 주석으로 트리 쉐이킹 방지
- ✅ 권한 요청 안정성 개선

**핵심 수정**:
```dart
// lib/core/services/notification_service.dart
// 백그라운드 알림 핸들러 등록
await _notificationsPlugin.initialize(
  initSettings,
  onDidReceiveNotificationResponse: _onNotificationTapped,
  onDidReceiveBackgroundNotificationResponse: _onNotificationTappedBackground, // ← 추가됨
);
```

## 💡 추가 팁

### 제조사별 특이사항

**삼성**:
- "앱 절전" 기능이 매우 공격적
- 설정 > 배터리 및 디바이스 케어 > 자동 최적화 끄기

**Xiaomi**:
- MIUI 보안 앱에서 "자동 실행" 허용 필수
- 설정 > 추가 설정 > 개발자 옵션 > 백그라운드 프로세스 제한 → "표준 제한"

**Huawei**:
- 설정 > 배터리 > 앱 실행 > DoDo → "수동 관리" 후 모두 허용

**OPPO/OnePlus**:
- 설정 > 배터리 > 배터리 최적화 > DoDo → "최적화하지 않음"

### 디버그 빌드 vs 릴리즈 빌드

현재 테스트 중인 것은 **릴리즈 빌드**입니다:
- ProGuard/R8 난독화 적용됨
- 디버그 심볼 포함됨
- 실제 Play Store 배포와 동일한 환경

디버그 빌드로 테스트하려면:
```bash
flutter build apk --debug
adb install build/app/outputs/flutter-apk/app-debug.apk
```

## 📞 여전히 안 될 때

1. 로그를 확인하여 구체적인 에러 메시지를 찾으세요
2. 기기 제조사와 Android 버전을 확인하세요
3. 다른 기기나 에뮬레이터에서 테스트해보세요
4. 알림 테스트 앱(예: Simple Notification Tester)으로 기기 자체의 알림 기능을 확인하세요

## 🎯 성공 시나리오

모든 설정이 올바르면:
1. 앱이 **포그라운드** 상태일 때도 알림이 표시됨
2. 앱이 **백그라운드** 상태일 때도 알림이 표시됨
3. 앱이 **완전히 종료**된 상태에서도 알림이 표시됨 (v1.0.2+11 핵심 수정)
4. 알림을 탭하면 앱이 열림
5. 알림에 **진동**과 **소리**가 남
6. 알림이 **헤드업(Head-up)** 형태로 화면 상단에 팝업으로 표시됨
