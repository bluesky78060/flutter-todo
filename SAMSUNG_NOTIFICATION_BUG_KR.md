# 삼성 One UI 알림 버그 - 중요 이슈

## 문제 요약

삼성 갤럭시 기기(One UI)에는 **시스템 레벨 버그**가 있습니다:
1. 새로 설치된 앱은 기본적으로 `allowNoti=false` 상태로 설치됨
2. 알림 권한 요청 다이얼로그가 **절대 나타나지 않음**
3. 사용자가 설정 UI에서 수동으로 알림을 활성화해도, 내부 `allowNoti` 시스템 플래그가 **업데이트되지 않음**
4. 이로 인해 모든 알림이 차단됨, 다음 사항들은 정상인데도:
   - 알람은 정상 발생 ✅
   - 알림 채널은 정상 생성 ✅
   - UI 설정은 "허용"으로 표시됨 ✅
   - 앱 코드는 정상 작동 ✅

## 확인된 사실

### 시스템 상태 (ADB로 확인)
```bash
# 다음 작업들을 모두 수행했는데도:
# - 앱 새로 설치
# - 앱 데이터 완전 삭제 (pm clear)
# - 설정에서 수동으로 권한 토글
# - 기기 재부팅
# 시스템은 여전히 다음과 같이 표시:
AppSettings: kr.bluesky.dodo (10276) allowNoti=false
```

### 정상 작동하는 것 ✅
- 알람 스케줄링: `SCHEDULE_EXACT_ALARM` 권한 허용됨
- 알림 채널 생성: `todo_notifications_v2` 중요도=5로 생성됨
- AlarmManager 전달: 알람이 정확한 시간에 발생
- 앱 초기화: 배터리 최적화 다이얼로그 표시됨
- 설정 UI: "알림 허용" 활성화로 표시됨

### 작동하지 않는 것 ❌
- `allowNoti` 시스템 플래그: **항상 false**
- 알림 권한 다이얼로그: **절대 나타나지 않음**
- 실제 알림 표시: **allowNoti=false에 의해 차단됨**
- 설정 토글 동기화: **UI가 시스템 상태를 업데이트하지 않음**

## 근본 원인

삼성 One UI가 기본 알림 동작을 변경했습니다:
1. **기본 거부**: 새 앱이 `allowNoti=true` 대신 `allowNoti=false`를 받음
2. **권한 다이얼로그 차단**: 안드로이드 13 알림 권한 다이얼로그가 제대로 표시되지 않음
3. **UI/시스템 비동기화**: 설정 UI는 한 상태를 보여주고, 시스템은 다른 상태를 유지
4. **배터리 최적화 우선순위**: 삼성은 알림 기능보다 배터리 수명을 우선시

## 시도했지만 실패한 해결 방법들

### 1. 앱 재설치 ❌
```bash
adb uninstall kr.bluesky.dodo
adb install -r app-release.apk
# 결과: allowNoti=false 유지됨
```

### 2. 데이터 삭제 ❌
```bash
adb shell pm clear kr.bluesky.dodo
# 결과: 새로 시작해도 allowNoti=false
```

### 3. 수동 설정 토글 ❌
- 사용자가 다음 경로로 이동: 설정 → 앱 → DODO → 알림 → 토글 ON
- 결과: UI는 활성화로 표시되지만 `allowNoti=false` 변경 없음

### 4. 채널 활성화 ❌
- 사용자 확인: Todo Reminders 채널 활성화됨
- 결과: 채널은 중요도=5로 존재하지만 `allowNoti=false`가 표시 차단

### 5. 강제 종료 + 재시작 ❌
```bash
adb shell am force-stop kr.bluesky.dodo
adb shell am start -n kr.bluesky.dodo/.MainActivity
# 결과: allowNoti=false 유지됨
```

### 6. 기기 재부팅 ❌
- 사용자가 기기 재부팅
- 결과: 재부팅 후에도 allowNoti=false 유지됨

### 7. ADB 권한 부여 ❌
```bash
adb shell pm grant kr.bluesky.dodo android.permission.POST_NOTIFICATIONS
# 오류: 이 안드로이드 버전에서는 ADB를 통한 권한 부여 지원 안 됨
```

## 해결 방법

**유일한** 해결 방법은 **삼성 디바이스 케어** 설정을 통하는 것입니다:

### 단계별 해결 방법

**1. 설정 앱 열기**

**2. 배터리 및 디바이스 케어로 이동**
- 설정 → 배터리 및 디바이스 케어 → 알림
- **주의**: 설정 → 앱 → DODO → 알림이 **아닙니다**

**3. "DODO" 또는 앱 이름 찾기**
- 최근 설치된 앱 섹션에서 찾기
- 또는 앱 이름으로 검색

**4. 마스터 알림 스위치 활성화**
- 앱에 대한 **마스터 토글**이 있어야 함
- 이것이 실제 `allowNoti` 시스템 플래그를 업데이트함
- 일반 설정 → 앱 → 알림은 UI 상태만 업데이트함

**5. 수정 확인**
```bash
~/Library/Android/sdk/platform-tools/adb -s RF9NB0146AB shell dumpsys notification | grep "kr.bluesky.dodo" | grep "allowNoti"
# 다음과 같이 표시되어야 함: allowNoti=true
```

**6. 즉시 테스트**
- 지금부터 2분 후 알림 설정
- 앱을 백그라운드로 전환
- 알림 대기
- 헤드업 알림으로 표시되어야 함

## 대체 솔루션 (위 방법이 작동하지 않는 경우)

### 옵션 A: 개발자 모드 우회 방법
1. 개발자 옵션 활성화 (빌드 번호 7번 탭)
2. 개발자 옵션 → "활동 유지 안 함" → 활성화
3. 이렇게 하면 백그라운드로 전환할 때마다 시스템 상태 새로고침 강제
4. 권한 상태 동기화에 도움이 될 수 있음

### 옵션 B: 앱 기본 설정 초기화
1. 설정 → 앱 → 세 점 메뉴 → 앱 기본 설정 초기화
2. **경고**: 모든 앱의 모든 앱 권한 초기화
3. 그런 다음 DODO를 재설치하고 즉시 알림 권한 활성화

### 옵션 C: 삼성 멤버스 앱
1. 삼성 멤버스 앱 열기
2. 지원 → 오류 신고로 이동
3. "kr.bluesky.dodo 알림 권한이 작동하지 않음" 신고
4. 삼성이 기기별 수정 방법 제공할 수 있음

### 옵션 D: 안전 모드 테스트
1. 안전 모드로 기기 재부팅 (전원 + 볼륨 다운 버튼 길게 누름)
2. 안전 모드에서 앱 설치 및 테스트
3. 안전 모드에서 작동 → 서드파티 앱이 간섭
4. 여전히 실패 → 삼성 펌웨어 버그

## 개발자 노트

### 앱 코드가 문제가 아닌 이유

우리 앱은 안드로이드 알림 권한을 올바르게 구현했습니다:
- ✅ `POST_NOTIFICATIONS` 권한 요청 (안드로이드 13+)
- ✅ 정확한 타이밍을 위해 `SCHEDULE_EXACT_ALARM` 사용
- ✅ 최대 중요도(5)로 알림 채널 생성
- ✅ 권한 거부를 우아하게 처리
- ✅ AlarmManager.setExactAndAllowWhileIdle()을 통해 알람 예약
- ✅ 비삼성 기기에서 완벽하게 작동

코드는 정확합니다. 이것은 **삼성 One UI 시스템 버그**입니다.

### 다른 기기에서 테스트

앱 코드가 올바르게 작동하는지 확인하려면 다음에서 테스트하세요:
- **Google Pixel** (순정 안드로이드 13+)
- **OnePlus** (OxygenOS)
- **Xiaomi** (MIUI 최적화 비활성화)
- **안드로이드 에뮬레이터** (API 33+ AVD)

모두 다음과 같이 표시되어야 합니다:
- 권한 다이얼로그 표시됨 ✅
- 권한 부여 후 알림 표시됨 ✅
- 권한 부여 후 `allowNoti=true` ✅

## 삼성 문서

삼성은 One UI 5.0+에서 이 문제를 인정하지만 명확한 수정 방법은 제공하지 않습니다:
- 배터리 최적화가 알림 권한 동기화 차단 가능
- "스마트 배터리" 기능이 권한 다이얼로그 차단 가능
- "절전 앱" 기능이 자주 사용하지 않는 앱의 알림 자동 비활성화

## 관련 삼성 이슈

이것은 더 광범위한 삼성 배터리 최적화 문제의 일부입니다:
1. **백그라운드 실행 제한**: 앱이 예외 설정해도 백그라운드 실행 불가
2. **알림 차단**: 시스템이 "배터리 절약"을 위해 알림 차단
3. **권한 다이얼로그 차단**: 시스템이 "사용자 보호"를 위해 권한 요청 방지
4. **설정 비동기화**: UI 상태가 시스템 상태와 일치하지 않음

삼성은 앱 기능보다 배터리 수명을 우선시하여 표준 안드로이드 동작을 망가뜨립니다.

## 결론

**이것은 앱 버그가 아닙니다.** 이것은 다음과 같은 삼성 One UI 시스템 버그입니다:
- 권한 다이얼로그가 나타나지 않음
- 설정 UI가 시스템 상태와 동기화되지 않음
- 표준 안드로이드 API가 문서대로 작동하지 않음

수정하려면 사용자가 표준 안드로이드 설정 앱이 아닌 삼성의 배터리 및 디바이스 케어 설정을 통해 수동으로 알림을 활성화해야 합니다.

## 사용자가 취해야 할 조치

다음 경로로 이동해 주세요:
**설정 → 배터리 및 디바이스 케어 → 알림 → DODO → 활성화**

이것이 삼성 One UI 기기에서 `allowNoti=true`를 제대로 설정하는 **유일한 경로**입니다.
